# Руководство по стилю комментариев в коде

## Общие принципы

### 1. Язык комментариев
- Все комментарии в коде должны быть написаны на русском языке
- Используйте четкий и понятный русский язык
- Избегайте сленга и разговорных выражений

### 2. Типы комментариев

#### Однострочные комментарии
```python
# Преобразуем user_id в целое число
user_id = int(user_id)

# Проверяем существование пользователя в базе данных
user = User.objects.filter(id=user_id).first()
```

#### Многострочные комментарии для функций и классов
```python
def calculate_pregnancy_week(due_date):
    """
    Рассчитывает текущую неделю беременности на основе предполагаемой даты родов.
    
    Args:
        due_date (datetime): Предполагаемая дата родов
        
    Returns:
        int: Номер текущей недели беременности (1-42)
        
    Raises:
        ValueError: Если дата родов в прошлом
    """
```

#### Комментарии к классам
```python
class FeedingSession(models.Model):
    """
    Модель для хранения информации о сеансах кормления ребенка.
    
    Attributes:
        user: Пользователь, которому принадлежит сеанс
        start_time: Время начала кормления
        end_time: Время окончания кормления
        left_breast_duration: Продолжительность кормления левой грудью
        right_breast_duration: Продолжительность кормления правой грудью
    """
```

### 3. Специальные случаи

#### Комментарии к конфигурации
```python
# Настройка подключения к базе данных SQLite для разработки
DATABASE_URL = 'sqlite:///data/mom_baby_bot.db'

# Параметры подключения для многопоточной среды
CONNECT_ARGS = {"check_same_thread": False}
```

#### Комментарии к алгоритмам
```python
# Алгоритм расчета возраста ребенка в месяцах
# Используем приблизительный расчет: 30 дней = 1 месяц
age_in_days = (today - birth_date).days
age_in_months = age_in_days // 30
```

#### TODO и FIXME комментарии
```python
# TODO: Добавить валидацию для отрицательных значений веса
# FIXME: Исправить проблему с часовыми поясами в расчете недель беременности
# NOTE: Этот метод может быть оптимизирован в будущих версиях
```

### 4. Что НЕ нужно комментировать

#### Очевидный код
```python
# ПЛОХО: Слишком очевидно
user_id = 1  # Устанавливаем user_id в 1

# ХОРОШО: Объясняем причину
user_id = 1  # Используем тестового пользователя для демонстрации
```

#### Самодокументируемый код
```python
# ПЛОХО: Функция уже понятна из названия
def get_user_by_id(user_id):
    # Получаем пользователя по ID
    return User.objects.get(id=user_id)

# ХОРОШО: Добавляем важную информацию
def get_user_by_id(user_id):
    # Возвращает None если пользователь не найден, вместо исключения
    return User.objects.filter(id=user_id).first()
```

### 5. Форматирование

#### Отступы и пробелы
```python
# Один пробел после символа #
# Правильно

#Неправильно - нет пробела

#    Неправильно - слишком много пробелов
```

#### Длина строк
- Комментарии должны помещаться в 80 символов
- Для длинных комментариев используйте перенос строки

```python
# Этот комментарий слишком длинный и должен быть разбит на несколько строк
# для лучшей читаемости кода

# Правильно:
# Этот комментарий разбит на несколько строк
# для лучшей читаемости кода
```

### 6. Комментарии к API

#### Документация эндпоинтов
```python
class UserAPIView(APIView):
    """
    API для управления пользователями.
    
    Поддерживаемые методы:
    - GET: Получение информации о пользователе
    - POST: Создание нового пользователя
    - PUT: Обновление информации о пользователе
    - DELETE: Удаление пользователя
    """
    
    def get(self, request, user_id):
        """
        Получение информации о пользователе.
        
        Args:
            request: HTTP запрос
            user_id: Идентификатор пользователя
            
        Returns:
            JsonResponse: Информация о пользователе или ошибка
        """
```

### 7. Комментарии к сложной логике

```python
# Расчет недели беременности основан на стандартной акушерской практике:
# - Беременность длится 40 недель (280 дней) от последней менструации
# - Первый день последней менструации считается началом беременности
# - Предполагаемая дата родов рассчитывается как начало + 280 дней
def calculate_pregnancy_week(last_menstrual_period):
    today = date.today()
    days_pregnant = (today - last_menstrual_period).days
    
    # Добавляем 1, так как первая неделя начинается с дня 0
    week = (days_pregnant // 7) + 1
    
    # Ограничиваем диапазон от 1 до 42 недель
    return max(1, min(42, week))
```

### 8. Комментарии к импортам

```python
# Стандартные библиотеки Python
import os
import sys
from datetime import datetime, timedelta

# Библиотеки Django
from django.db import models
from django.contrib.auth.models import User

# Сторонние библиотеки
from sqlalchemy import Column, Integer, String
import requests

# Локальные импорты
from .models import Child, Measurement
from .utils import calculate_age
```

## Примеры хороших комментариев

### Объяснение бизнес-логики
```python
# В соответствии с рекомендациями ВОЗ, нормальный вес новорожденного
# составляет от 2500 до 4000 граммов
MIN_NORMAL_WEIGHT = 2500  # граммы
MAX_NORMAL_WEIGHT = 4000  # граммы
```

### Объяснение технических решений
```python
# Используем SQLAlchemy вместо Django ORM для этой модели
# из-за необходимости совместимости с телеграм-ботом
class User(Base):
    __tablename__ = 'users'
```

### Предупреждения и важные замечания
```python
# ВНИМАНИЕ: Этот метод изменяет состояние базы данных
# Всегда вызывайте в транзакции
def update_user_premium_status(user_id, is_premium):
    # Реализация метода
    pass
```

## Дополнительные рекомендации

### 9. Комментарии к сложным алгоритмам

```python
def calculate_feeding_statistics(sessions):
    """
    Рассчитывает статистику кормления на основе сессий.
    
    Алгоритм учитывает:
    - Продолжительность каждой сессии
    - Интервалы между кормлениями
    - Предпочтения по грудям (левая/правая)
    """
    # Сортируем сессии по времени начала для корректного расчета интервалов
    sorted_sessions = sorted(sessions, key=lambda s: s.start_time)
    
    # Группируем сессии по дням для дневной статистики
    daily_groups = {}
    for session in sorted_sessions:
        day_key = session.start_time.date()
        if day_key not in daily_groups:
            daily_groups[day_key] = []
        daily_groups[day_key].append(session)
```

### 10. Комментарии к исправлениям ошибок

```python
def validate_pregnancy_week(week):
    """Валидация недели беременности."""
    # ИСПРАВЛЕНИЕ: Добавлена проверка на отрицательные значения
    # Ранее функция не обрабатывала некорректный ввод
    if week < 1:
        raise ValueError("Неделя беременности не может быть меньше 1")
    
    # Стандартная беременность длится до 42 недель
    if week > 42:
        logger.warning(f"Необычно большая неделя беременности: {week}")
    
    return week
```

### 11. Комментарии к временным решениям

```python
def get_user_timezone(user_id):
    """Получение часового пояса пользователя."""
    # ВРЕМЕННОЕ РЕШЕНИЕ: Используем UTC для всех пользователей
    # TODO: Добавить поддержку определения часового пояса по геолокации
    # или позволить пользователю выбирать часовой пояс в настройках
    return timezone.utc
```

### 12. Комментарии к производительности

```python
@lru_cache(maxsize=128)
def get_vaccine_schedule(child_age_months):
    """
    Получение расписания прививок для ребенка определенного возраста.
    
    ОПТИМИЗАЦИЯ: Результат кешируется, так как расписание прививок
    не изменяется часто и одинаково для детей одного возраста.
    """
    # Реализация функции
    pass
```

### 13. Комментарии к безопасности

```python
def sanitize_user_input(input_text):
    """Очистка пользовательского ввода от потенциально опасного содержимого."""
    # БЕЗОПАСНОСТЬ: Удаляем HTML теги для предотвращения XSS атак
    cleaned_text = re.sub(r'<[^>]+>', '', input_text)
    
    # БЕЗОПАСНОСТЬ: Ограничиваем длину ввода
    if len(cleaned_text) > 1000:
        cleaned_text = cleaned_text[:1000]
        logger.warning("Пользовательский ввод был обрезан из-за превышения лимита")
    
    return cleaned_text
```

### 14. Комментарии к интеграциям

```python
def send_telegram_notification(user_id, message):
    """
    Отправка уведомления через Telegram Bot API.
    
    ИНТЕГРАЦИЯ: Использует официальный Telegram Bot API
    Документация: https://core.telegram.org/bots/api
    """
    # Формирование запроса к API
    api_url = f"https://api.telegram.org/bot{BOT_TOKEN}/sendMessage"
    
    # Параметры запроса согласно документации API
    payload = {
        'chat_id': user_id,
        'text': message,
        'parse_mode': 'HTML'  # Поддержка HTML разметки в сообщениях
    }
```

## Заключение

Следование этому руководству поможет поддерживать код в читаемом состоянии и облегчит работу всей команды разработчиков. Помните: хороший комментарий объясняет "почему", а не "что".

### Основные принципы:
1. **Ясность** - комментарии должны быть понятными
2. **Актуальность** - обновляйте комментарии при изменении кода
3. **Полезность** - комментируйте только то, что действительно нуждается в объяснении
4. **Единообразие** - следуйте установленному стилю во всем проекте