# Исправления для деплоя на Amvera

## Проблема
Ошибка `unable to open database file` при деплое на Amvera из-за проблем с доступом к SQLite базе данных.

## Решение

### 1. Множественные пути для базы данных
Система теперь пробует несколько путей:
- `/app/data/mom_baby_bot.db` (основной)
- `./mom_baby_bot.db` (текущая директория)
- `/tmp/mom_baby_bot.db` (временная директория)
- `/var/tmp/mom_baby_bot.db` (альтернативная временная)

### 2. Новые скрипты

#### `check_amvera_ready.py`
- Проверка готовности к запуску
- Тестирование доступа к базе данных
- Проверка переменных окружения

#### `init_sqlite_amvera.py`
- Инициализация базы данных
- Автоматический поиск доступного пути
- Применение миграций Django и SQLAlchemy

#### `test_db_amvera.py`
- Тестирование базы данных
- Проверка записи/чтения данных
- Интеграция с Django

#### `quick_test_amvera.py`
- Быстрый тест основных компонентов
- Проверка директорий и переменных окружения

#### `diagnose_amvera.py`
- Полная диагностика системы
- Проверка прав доступа
- Тестирование зависимостей

### 3. Обновленные файлы

#### `settings_prod.py`
- Использование переменной `DATABASE_PATH`
- Автоматическое создание директорий
- Fallback механизм

#### `sqlalchemy_utils.py`
- Улучшенная обработка ошибок
- Автоматический поиск доступного пути
- Подробное логирование

#### `start.sh`
- Улучшенная проверка базы данных
- Использование новых скриптов
- Лучшая обработка ошибок

#### `Dockerfile`
- Создание дополнительных директорий
- Правильные права доступа
- Поддержка временных директорий

### 4. Переменные окружения

**Обязательные:**
- `SECRET_KEY` - секретный ключ Django
- `DJANGO_SETTINGS_MODULE` - `mom_baby_bot.settings_prod`

**Опциональные:**
- `TELEGRAM_BOT_TOKEN` - токен бота
- `WEBHOOK_URL` - URL webhook
- `WEBAPP_URL` - URL приложения
- `ADMIN_IDS` - ID администраторов

### 5. Инструкции по деплою

1. **Подготовка:**
   - Убедитесь, что код загружен в Git
   - Настройте переменные окружения в Amvera

2. **Деплой:**
   - Подключите репозиторий к Amvera
   - Запустите деплой
   - Проверьте логи

3. **Мониторинг:**
   - Ищите сообщения "✅ База данных доступна"
   - Проверьте "✅ SQLAlchemy инициализирован"
   - Убедитесь в "✅ Django миграции применены"

### 6. Тестирование

```bash
# Быстрый тест
python quick_test_amvera.py

# Полная диагностика
python diagnose_amvera.py

# Тест базы данных
python test_db_amvera.py
```

### 7. Устранение проблем

| Проблема | Решение |
|----------|---------|
| "unable to open database file" | Система автоматически попробует альтернативные пути |
| "Permission denied" | Проверьте права доступа в контейнере |
| "Directory does not exist" | Директории создаются автоматически |

### 8. Логи

Важные сообщения:
- `INFO` - нормальная работа
- `WARNING` - предупреждения (не критично)
- `ERROR` - ошибки (требуют внимания)

## Результат

После применения этих исправлений:
- ✅ База данных будет создана автоматически
- ✅ Система найдет доступный путь для записи
- ✅ Все миграции применятся корректно
- ✅ SQLAlchemy инициализируется правильно
- ✅ Приложение запустится без ошибок

## Контакты

При проблемах:
1. Проверьте логи в панели Amvera
2. Убедитесь в правильности переменных окружения
3. Запустите диагностику: `python diagnose_amvera.py` 