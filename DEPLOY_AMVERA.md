# Развертывание на Amvera Cloud

Этот документ содержит инструкции по развертыванию Mom&Baby Bot на платформе Amvera Cloud.

## Подготовка к развертыванию

### 1. Настройка репозитория

Убедитесь, что ваш код находится в Git репозитории (GitHub, GitLab, Bitbucket).

### 2. Файлы конфигурации

Проект уже содержит необходимые файлы:
- `Dockerfile` - конфигурация Docker контейнера
- `amvera.yml` - конфигурация для Amvera
- `.dockerignore` - исключения для Docker сборки

## Развертывание на Amvera

### 1. Создание проекта

1. Зайдите на [cloud.amvera.ru](https://cloud.amvera.ru/)
2. Создайте новый проект
3. Подключите ваш Git репозиторий

### 2. Настройка переменных окружения

В панели управления Amvera установите следующие переменные окружения:

#### Обязательные переменные:
```
DEBUG=False
DJANGO_SETTINGS_MODULE=mom_baby_bot.settings_prod
SECRET_KEY=ваш-секретный-ключ-django
```

#### Опциональные переменные (для Telegram бота):
```
TELEGRAM_BOT_TOKEN=ваш-токен-бота
ADMIN_IDS=список-id-администраторов-через-запятую
WEBHOOK_URL=https://ваш-домен.amvera.ru/webhook
WEBAPP_URL=https://ваш-домен.amvera.ru
```

#### Настройки домена:
```
ALLOWED_HOSTS=ваш-домен.amvera.ru,*.amvera.ru
USE_HTTPS=True
```

### 3. База данных

Приложение использует SQLite базу данных, которая создается автоматически в контейнере.
Никаких внешних сервисов баз данных не требуется.

### 4. Развертывание

1. Нажмите "Deploy" в панели управления
2. Amvera автоматически:
   - Соберет Docker образ
   - Применит миграции базы данных
   - Соберет статические файлы
   - Запустит приложение

## Мониторинг

### Health Check

Приложение предоставляет endpoint для проверки состояния:
```
GET /health/
```

### Логи

Просматривайте логи в панели управления Amvera или через CLI.

## Обновление

Для обновления приложения:
1. Внесите изменения в код
2. Сделайте commit и push в репозиторий
3. Amvera автоматически пересоберет и развернет новую версию

## Настройка домена

1. В панели управления Amvera перейдите в раздел "Домены"
2. Добавьте ваш домен
3. Обновите переменные окружения `ALLOWED_HOSTS`, `WEBHOOK_URL`, `WEBAPP_URL`

## Масштабирование

Amvera поддерживает автоматическое масштабирование. Настройте его в панели управления в зависимости от нагрузки.

## Резервное копирование

Настройте автоматическое резервное копирование базы данных в панели управления Amvera.

## Отладка проблем

### Если приложение не запускается

1. **Проверьте логи в панели Amvera**
2. **Используйте debug версию для диагностики:**
   - Переименуйте `amvera.debug.yml` в `amvera.yml`
   - Это запустит приложение в debug режиме с Django dev server

3. **Проверьте переменные окружения:**
   ```bash
   # В консоли Amvera
   env | grep -E "(DATABASE_URL|REDIS_URL|SECRET_KEY)"
   ```

4. **Запустите диагностические скрипты:**
   ```bash
   python check_before_start.py
   python test_production_setup.py
   ```

## Troubleshooting

### Проблемы с базой данных
Если приложение не может подключиться к базе данных:
1. Убедитесь, что PostgreSQL сервис включен в amvera.yml
2. Проверьте, что переменная DATABASE_URL установлена автоматически
3. Проверьте логи на наличие ошибок подключения

### Проблемы с миграциями
Миграции применяются автоматически при запуске. Если возникли проблемы:
```bash
# Через консоль Amvera
python manage.py migrate --noinput
```

### Проблемы со статическими файлами
```bash
python manage.py collectstatic --noinput --clear
```

### Проблемы с SQLAlchemy
Если SQLAlchemy не может инициализироваться:
```bash
# Через Django management command
python manage.py init_sqlalchemy

# Принудительная пересоздание таблиц
python manage.py init_sqlalchemy --force

# Альтернативный способ
python init_sqlalchemy_production.py
```

### Проверка логов
```bash
# Просмотр логов приложения
amvera logs

# Просмотр логов в реальном времени  
amvera logs -f

# Проверка health check
curl https://ваш-домен.amvera.ru/health/
```

### Проверка переменных окружения
```bash
# В консоли Amvera
env | grep -E "(DATABASE_URL|REDIS_URL|SECRET_KEY|TELEGRAM_BOT_TOKEN)"
```

## Безопасность

- Используйте сильный `SECRET_KEY`
- Регулярно обновляйте зависимости
- Мониторьте логи на предмет подозрительной активности
- Настройте HTTPS (включено по умолчанию)

## Поддержка

При возникновении проблем:
1. Проверьте логи в панели управления
2. Убедитесь, что все переменные окружения настроены правильно
3. Обратитесь в поддержку Amvera