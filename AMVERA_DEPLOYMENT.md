# Деплой на Amvera

## Проблема

Основная проблема с деплоем на Amvera связана с доступом к SQLite базе данных. Ошибка `unable to open database file` возникает из-за того, что:

1. Директория `/app/data` может не существовать
2. Нет прав на запись в эту директорию
3. Контейнер может не иметь доступа к определенным путям

## Решение

### 1. Множественные пути для базы данных

Система теперь пробует несколько путей для создания базы данных:
- `/app/data/mom_baby_bot.db` (основной путь)
- `./mom_baby_bot.db` (текущая директория)
- `/tmp/mom_baby_bot.db` (временная директория)
- `/var/tmp/mom_baby_bot.db` (альтернативная временная директория)

### 2. Улучшенная обработка ошибок

- Автоматическое создание директорий
- Fallback механизм при ошибках
- Подробное логирование всех операций

### 3. Новые скрипты

#### `check_amvera_ready.py`
Проверяет готовность к запуску:
- Доступ к базе данных
- Настройки Django
- Переменные окружения
- Необходимые директории

#### `init_sqlite_amvera.py`
Инициализирует базу данных:
- Находит доступный путь
- Создает базу данных
- Применяет миграции Django
- Создает таблицы SQLAlchemy

#### `test_db_amvera.py`
Тестирует базу данных:
- Создание тестовых таблиц
- Запись и чтение данных
- Интеграция с Django

### 4. Обновленные файлы

#### `settings_prod.py`
- Использует переменную окружения `DATABASE_PATH`
- Автоматическое создание директорий
- Fallback механизм

#### `start.sh`
- Улучшенная проверка базы данных
- Использование новых скриптов
- Лучшая обработка ошибок

#### `Dockerfile`
- Создание дополнительных директорий
- Правильные права доступа
- Поддержка временных директорий

## Инструкции по деплою

### 1. Подготовка

Убедитесь, что у вас есть:
- Аккаунт на Amvera
- Настроенный домен
- Переменные окружения

### 2. Переменные окружения

В панели Amvera установите:

**Обязательные:**
- `SECRET_KEY` - сильный секретный ключ Django
- `DJANGO_SETTINGS_MODULE` - `mom_baby_bot.settings_prod`

**Опциональные:**
- `TELEGRAM_BOT_TOKEN` - токен Telegram бота
- `WEBHOOK_URL` - URL для webhook
- `WEBAPP_URL` - URL веб-приложения
- `ADMIN_IDS` - ID администраторов через запятую

### 3. Деплой

1. Загрузите код в Git репозиторий
2. Подключите репозиторий к Amvera
3. Настройте переменные окружения
4. Запустите деплой

### 4. Мониторинг

После деплоя проверьте логи на наличие:
- ✅ "База данных доступна по пути"
- ✅ "SQLAlchemy инициализирован успешно"
- ✅ "Django миграции применены"

### 5. Устранение проблем

#### Проблема: "unable to open database file"
**Решение:** Система автоматически попробует альтернативные пути

#### Проблема: "Permission denied"
**Решение:** Проверьте права доступа в контейнере

#### Проблема: "Directory does not exist"
**Решение:** Директории создаются автоматически

## Тестирование

Для тестирования базы данных запустите:

```bash
python test_db_amvera.py
```

Для проверки готовности:

```bash
python check_amvera_ready.py
```

## Логи

Важные сообщения в логах:

- `INFO` - нормальная работа
- `WARNING` - предупреждения (не критично)
- `ERROR` - ошибки (требуют внимания)

## Контакты

При возникновении проблем:
1. Проверьте логи в панели Amvera
2. Убедитесь, что все переменные окружения установлены
3. Проверьте права доступа к файлам

## Обновления

Система автоматически:
- Создает необходимые директории
- Находит доступный путь для базы данных
- Применяет миграции
- Инициализирует SQLAlchemy 