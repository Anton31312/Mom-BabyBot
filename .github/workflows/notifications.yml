name: –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

on:
  workflow_run:
    workflows: ["–ù–µ–ø—Ä–µ—Ä—ã–≤–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è", "–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞ –∫–æ–¥–∞"]
    types:
      - completed

jobs:
  notify-success:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    
    steps:
    - name: –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—à–Ω–æ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏
      run: |
        echo "‚úÖ Workflow '${{ github.event.workflow_run.name }}' –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ"
        echo "üîó –°—Å—ã–ª–∫–∞: ${{ github.event.workflow_run.html_url }}"
        echo "üìù –ö–æ–º–º–∏—Ç: ${{ github.event.workflow_run.head_sha }}"
        echo "üåø –í–µ—Ç–∫–∞: ${{ github.event.workflow_run.head_branch }}"

  notify-failure:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    
    steps:
    - name: –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
      run: |
        echo "‚ùå Workflow '${{ github.event.workflow_run.name }}' –∑–∞–≤–µ—Ä—à–µ–Ω —Å –æ—à–∏–±–∫–æ–π"
        echo "üîó –°—Å—ã–ª–∫–∞: ${{ github.event.workflow_run.html_url }}"
        echo "üìù –ö–æ–º–º–∏—Ç: ${{ github.event.workflow_run.head_sha }}"
        echo "üåø –í–µ—Ç–∫–∞: ${{ github.event.workflow_run.head_branch }}"
        echo ""
        echo "üîç –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–¥—Ä–æ–±–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± –æ—à–∏–±–∫–∞—Ö"
        echo "üí° –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:"
        echo "   - –ù–µ –ø—Ä–æ—à–ª–∏ —Ç–µ—Å—Ç—ã"
        echo "   - –û—à–∏–±–∫–∏ –≤ –∫–æ–¥–µ"
        echo "   - –ü—Ä–æ–±–ª–µ–º—ã —Å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è–º–∏"
        echo "   - –ù–∞—Ä—É—à–µ–Ω–∏—è —Å—Ç–∏–ª—è –∫–æ–¥–∞"

  create-issue-on-failure:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'failure' && github.event.workflow_run.head_branch == 'main' }}
    
    steps:
    - name: –°–æ–∑–¥–∞–Ω–∏–µ issue –ø—Ä–∏ –æ—à–∏–±–∫–µ –≤ main
      uses: actions/github-script@v6
      with:
        script: |
          const title = `üö® CI/CD –æ—à–∏–±–∫–∞ –≤ main –≤–µ—Ç–∫–µ - ${context.payload.workflow_run.name}`;
          const body = `
          ## üö® –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –≤ CI/CD
          
          **Workflow:** ${context.payload.workflow_run.name}
          **–í–µ—Ç–∫–∞:** ${context.payload.workflow_run.head_branch}
          **–ö–æ–º–º–∏—Ç:** ${context.payload.workflow_run.head_sha}
          **–í—Ä–µ–º—è:** ${new Date(context.payload.workflow_run.created_at).toLocaleString('ru-RU')}
          
          ### üîó –°—Å—ã–ª–∫–∏
          - [–õ–æ–≥–∏ workflow](${context.payload.workflow_run.html_url})
          - [–ö–æ–º–º–∏—Ç](${context.payload.workflow_run.head_commit.url})
          
          ### üìã –ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å
          1. üîç –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ª–æ–≥–∏ –æ—à–∏–±–æ–∫
          2. üõ†Ô∏è –ò—Å–ø—Ä–∞–≤–∏—Ç—å –Ω–∞–π–¥–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã
          3. ‚úÖ –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç –ª–æ–∫–∞–ª—å–Ω–æ
          4. üöÄ –°–æ–∑–¥–∞—Ç—å hotfix –µ—Å–ª–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ
          
          ### üè∑Ô∏è –ú–µ—Ç–∫–∏
          –≠—Ç–æ—Ç issue –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–º–µ—á–µ–Ω –∫–∞–∫ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –∏ —Ç—Ä–µ–±—É–µ—Ç –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ –≤–Ω–∏–º–∞–Ω–∏—è.
          
          ---
          *–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–Ω–æ GitHub Actions*
          `;
          
          github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: title,
            body: body,
            labels: ['bug', 'critical', 'ci/cd', 'automated']
          });