# Тесты для веб-интерфейса материнского ухода

## Обзор

В рамках задач "6.1 Провести модульное тестирование" и "6.2 Провести интеграционное тестирование" были созданы тесты для всех компонентов веб-интерфейса материнского ухода. Тесты охватывают модели данных, API-эндпоинты и взаимодействие между компонентами для следующих функциональных областей:

1. Профили детей и измерения
2. Счетчик схваток
3. Счетчик шевелений
4. Таймер сна
5. Отслеживание кормления
6. Календарь прививок

## Структура тестов

Тесты организованы по функциональным областям и типам:

### Модульные тесты

#### Тесты моделей

- `test_child_models.py` - тесты для моделей Child и Measurement
- `test_contraction_models.py` - тесты для моделей Contraction и ContractionEvent
- `test_kick_models.py` - тесты для моделей Kick и KickEvent
- `test_sleep_models.py` - тесты для модели SleepSession
- `test_feeding_models.py` - тесты для модели FeedingSession

#### Тесты API

- `test_child_api.py` - тесты для API профилей детей и измерений
- `test_contraction_api.py` - тесты для API счетчика схваток
- `test_kick_api.py` - тесты для API счетчика шевелений
- `test_sleep_api.py` - тесты для API таймера сна
- `test_feeding_api.py` - тесты для API отслеживания кормления
- `test_vaccine_api.py` - тесты для API календаря прививок

### Интеграционные тесты

- `test_integration.py` - основные интеграционные тесты, проверяющие взаимодействие между компонентами
- `test_api_integration.py` - тесты интеграции между различными API-интерфейсами
- `test_sync_integration.py` - тесты синхронизации данных между веб-интерфейсом и Telegram ботом

## Охват тестами

### Модульные тесты

#### Модели данных

- Создание объектов
- Получение объектов
- Обновление объектов
- Удаление объектов
- Проверка свойств и методов моделей
- Проверка связей между моделями

#### API-эндпоинты

- Получение списков объектов (GET)
- Получение деталей объекта (GET)
- Создание объектов (POST)
- Обновление объектов (PUT)
- Удаление объектов (DELETE)
- Обработка ошибок (несуществующие объекты, неправильные данные и т.д.)
- Проверка прав доступа (принадлежность объектов пользователю)

### Интеграционные тесты

#### Взаимодействие между компонентами

- Интеграция между пользователем и профилями детей
- Интеграция между счетчиками схваток и шевелений
- Интеграция между таймером сна и отслеживанием кормления
- Интеграция календаря прививок с профилем ребенка
- Комплексные пользовательские сценарии

#### API-интерфейсы

- Взаимодействие между различными API-эндпоинтами
- Проверка корректной работы API при различных сценариях использования
- Обработка ошибок в API

#### Синхронизация данных

- Синхронизация данных пользователя между Telegram и веб-интерфейсом
- Синхронизация данных ребенка между Telegram и веб-интерфейсом
- Синхронизация данных о сне, кормлении и прививках
- Работа эндпоинта для обмена данными между веб-приложением и Telegram ботом

## Запуск тестов

### Запуск модульных тестов

Для запуска модульных тестов используйте команду:

```bash
python manage.py test webapp.tests
```

Или для запуска конкретного теста:

```bash
python manage.py test webapp.tests.test_child_models
```

### Запуск интеграционных тестов

Для запуска интеграционных тестов используйте скрипт `run_integration_tests.py`:

```bash
python run_integration_tests.py
```

## Проблемы с запуском тестов

При попытке запуска тестов могут возникать проблемы с циклическими импортами в модулях проекта. Проблема заключается в том, что модули `botapp.models` и `botapp.models_child` импортируют друг друга, что приводит к ошибке:

```
ImportError: cannot import name 'db_manager' from partially initialized module 'botapp.models' (most likely due to a circular import)
```

### Решения проблемы с циклическими импортами

1. **Отложенный импорт**: В некоторых модулях используется отложенный импорт внутри функций или методов вместо импорта на уровне модуля.

2. **Импорт только необходимых компонентов**: Вместо импорта целых модулей импортируются только необходимые классы и функции.

3. **Использование абсолютных импортов**: Вместо относительных импортов используются абсолютные импорты, что помогает избежать некоторых проблем с циклическими зависимостями.

4. **Запуск тестов по отдельности**: Запускать тесты по отдельности, чтобы избежать одновременной загрузки всех модулей.

## Выявленные проблемы и их решения

### 1. Проблема с доступом к API для несуществующих пользователей

**Проблема**: API не всегда корректно обрабатывает запросы к несуществующим пользователям.

**Решение**: Добавлена проверка существования пользователя перед выполнением операций в API-обработчиках.

### 2. Проблема с валидацией данных

**Проблема**: Некоторые API-эндпоинты не выполняют достаточную валидацию входных данных.

**Решение**: Добавлена дополнительная валидация входных данных во всех API-эндпоинтах.

### 3. Проблема с синхронизацией данных

**Проблема**: При одновременном обновлении данных через веб-интерфейс и Telegram бота могут возникать конфликты.

**Решение**: Реализован механизм разрешения конфликтов на основе временных меток.

## Рекомендации

1. Регулярно запускать модульные и интеграционные тесты при внесении изменений в код.
2. Добавлять новые тесты при реализации новых функций.
3. Использовать результаты тестов для выявления и устранения проблем.
4. Настроить автоматический запуск тестов в процессе непрерывной интеграции (CI).
5. Решить проблему циклических импортов в модулях проекта для более стабильного запуска тестов.
