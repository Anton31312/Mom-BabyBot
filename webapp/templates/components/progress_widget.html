{% comment %}
–ö–æ–º–ø–æ–Ω–µ–Ω—Ç –≤–∏–¥–∂–µ—Ç–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–∞ –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ.

–≠—Ç–æ—Ç –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫—Ä–∞—Ç–∫—É—é —Å–≤–æ–¥–∫—É –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è,
–≤–∫–ª—é—á–∞—è —É—Ä–æ–≤–µ–Ω—å, –æ—á–∫–∏, —Å–µ—Ä–∏—é –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∏ –±–ª–∏–∂–∞–π—à–∏–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è.

–°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—é 9.4 –æ –≤–∏–∑—É–∞–ª—å–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π.
{% endcomment %}

<div class="progress-widget">
    <div class="widget-header">
        <h4 class="widget-title">
            <span class="widget-icon">üìä</span>
            –í–∞—à –ø—Ä–æ–≥—Ä–µ—Å—Å
        </h4>
        <a href="{% url 'webapp:progress_dashboard' %}" class="widget-link">
            –ü–æ–¥—Ä–æ–±–Ω–µ–µ ‚Üí
        </a>
    </div>
    
    <div class="widget-content">
        <!-- –£—Ä–æ–≤–µ–Ω—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
        <div class="level-section">
            <div class="level-display">
                <div class="level-number" id="widget-level">1</div>
                <div class="level-label">–£—Ä–æ–≤–µ–Ω—å</div>
            </div>
            <div class="level-progress">
                <div class="level-progress-bar">
                    <div class="level-progress-fill" id="widget-level-progress" style="width: 0%"></div>
                </div>
                <div class="level-points">
                    <span id="widget-points">0</span> –æ—á–∫–æ–≤
                </div>
            </div>
        </div>
        
        <!-- –ë—ã—Å—Ç—Ä–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
        <div class="quick-stats">
            <div class="stat-item">
                <div class="stat-icon">üî•</div>
                <div class="stat-content">
                    <div class="stat-number" id="widget-streak">0</div>
                    <div class="stat-label">–¥–Ω–µ–π –ø–æ–¥—Ä—è–¥</div>
                </div>
            </div>
            
            <div class="stat-item">
                <div class="stat-icon">üéØ</div>
                <div class="stat-content">
                    <div class="stat-number" id="widget-consistency">0%</div>
                    <div class="stat-label">–ø–æ—Å—Ç–æ—è–Ω—Å—Ç–≤–æ</div>
                </div>
            </div>
            
            <div class="stat-item">
                <div class="stat-icon">üèÜ</div>
                <div class="stat-content">
                    <div class="stat-number" id="widget-achievements">0</div>
                    <div class="stat-label">–¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π</div>
                </div>
            </div>
        </div>
        
        <!-- –ë–ª–∏–∂–∞–π—à–∏–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è -->
        <div class="next-achievements">
            <div class="section-title">–ë–ª–∏–∂–∞–π—à–∏–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è</div>
            <div id="widget-next-achievements" class="achievements-list">
                <!-- –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
            </div>
            <div id="widget-no-achievements" class="no-achievements" style="display: none;">
                <div class="empty-icon">üéâ</div>
                <div class="empty-text">–í—Å–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –ø–æ–ª—É—á–µ–Ω—ã!</div>
            </div>
        </div>
    </div>
    
    <!-- –ó–∞–≥—Ä—É–∑–∫–∞ -->
    <div id="widget-loading" class="widget-loading">
        <div class="loading-spinner"></div>
        <div class="loading-text">–ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å...</div>
    </div>
    
    <!-- –û—à–∏–±–∫–∞ -->
    <div id="widget-error" class="widget-error" style="display: none;">
        <div class="error-icon">‚ö†Ô∏è</div>
        <div class="error-text">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</div>
        <button class="retry-button" onclick="loadProgressWidget()">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å</button>
    </div>
</div>

<style>
.progress-widget {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 15px;
    padding: 20px;
    color: white;
    margin-bottom: 20px;
    position: relative;
    overflow: hidden;
}

.progress-widget::before {
    content: '';
    position: absolute;
    top: -50%;
    right: -50%;
    width: 100%;
    height: 100%;
    background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
    pointer-events: none;
}

.widget-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.widget-title {
    margin: 0;
    font-size: 1.2rem;
    font-weight: bold;
    display: flex;
    align-items: center;
    gap: 8px;
}

.widget-icon {
    font-size: 1.5rem;
}

.widget-link {
    color: rgba(255, 255, 255, 0.8);
    text-decoration: none;
    font-size: 0.9rem;
    transition: color 0.3s ease;
}

.widget-link:hover {
    color: white;
    text-decoration: none;
}

.widget-content {
    position: relative;
    z-index: 1;
}

.level-section {
    display: flex;
    align-items: center;
    gap: 20px;
    margin-bottom: 20px;
    padding: 15px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 12px;
    backdrop-filter: blur(10px);
}

.level-display {
    text-align: center;
    flex-shrink: 0;
}

.level-number {
    font-size: 2.5rem;
    font-weight: bold;
    line-height: 1;
    margin-bottom: 5px;
}

.level-label {
    font-size: 0.9rem;
    opacity: 0.9;
}

.level-progress {
    flex-grow: 1;
}

.level-progress-bar {
    background: rgba(255, 255, 255, 0.2);
    border-radius: 10px;
    height: 12px;
    margin-bottom: 8px;
    overflow: hidden;
}

.level-progress-fill {
    background: linear-gradient(90deg, #ffd700, #ffed4e);
    height: 100%;
    border-radius: 10px;
    transition: width 0.3s ease;
}

.level-points {
    font-size: 0.9rem;
    opacity: 0.9;
}

.quick-stats {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 15px;
    margin-bottom: 20px;
}

.stat-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 12px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 10px;
    backdrop-filter: blur(10px);
}

.stat-icon {
    font-size: 1.5rem;
    flex-shrink: 0;
}

.stat-content {
    flex-grow: 1;
    min-width: 0;
}

.stat-number {
    font-size: 1.2rem;
    font-weight: bold;
    line-height: 1;
    margin-bottom: 2px;
}

.stat-label {
    font-size: 0.8rem;
    opacity: 0.8;
    line-height: 1;
}

.next-achievements {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 12px;
    padding: 15px;
    backdrop-filter: blur(10px);
}

.section-title {
    font-size: 1rem;
    font-weight: bold;
    margin-bottom: 12px;
    opacity: 0.9;
}

.achievements-list {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.achievement-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    transition: background 0.3s ease;
}

.achievement-item:hover {
    background: rgba(255, 255, 255, 0.15);
}

.achievement-icon {
    font-size: 1.2rem;
    flex-shrink: 0;
}

.achievement-info {
    flex-grow: 1;
    min-width: 0;
}

.achievement-title {
    font-size: 0.9rem;
    font-weight: bold;
    line-height: 1.2;
    margin-bottom: 2px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.achievement-progress {
    font-size: 0.8rem;
    opacity: 0.8;
}

.achievement-progress-bar {
    background: rgba(255, 255, 255, 0.2);
    border-radius: 6px;
    height: 6px;
    margin-top: 4px;
    overflow: hidden;
}

.achievement-progress-fill {
    background: linear-gradient(90deg, #28a745, #20c997);
    height: 100%;
    border-radius: 6px;
    transition: width 0.3s ease;
}

.no-achievements {
    text-align: center;
    padding: 20px;
    opacity: 0.8;
}

.empty-icon {
    font-size: 2rem;
    margin-bottom: 8px;
}

.empty-text {
    font-size: 0.9rem;
}

.widget-loading {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 15px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 15px;
}

.loading-spinner {
    width: 40px;
    height: 40px;
    border: 3px solid rgba(255, 255, 255, 0.3);
    border-top: 3px solid white;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

.loading-text {
    font-size: 0.9rem;
    opacity: 0.8;
}

.widget-error {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
    border-radius: 15px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 10px;
    text-align: center;
}

.error-icon {
    font-size: 2rem;
}

.error-text {
    font-size: 0.9rem;
    margin-bottom: 10px;
}

.retry-button {
    background: rgba(255, 255, 255, 0.2);
    border: 1px solid rgba(255, 255, 255, 0.3);
    color: white;
    padding: 8px 16px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.9rem;
    transition: background 0.3s ease;
}

.retry-button:hover {
    background: rgba(255, 255, 255, 0.3);
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

@media (max-width: 768px) {
    .progress-widget {
        padding: 15px;
    }
    
    .level-section {
        flex-direction: column;
        text-align: center;
        gap: 15px;
    }
    
    .quick-stats {
        grid-template-columns: 1fr;
        gap: 10px;
    }
    
    .stat-item {
        justify-content: center;
    }
    
    .achievement-title {
        white-space: normal;
        overflow: visible;
        text-overflow: initial;
    }
}
</style>

<script>
async function loadProgressWidget() {
    const widget = document.querySelector('.progress-widget');
    const loading = document.getElementById('widget-loading');
    const error = document.getElementById('widget-error');
    const content = document.querySelector('.widget-content');
    
    try {
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
        loading.style.display = 'flex';
        error.style.display = 'none';
        content.style.display = 'none';
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
        const response = await fetch('/api/progress/summary/');
        const data = await response.json();
        
        if (!data.success) {
            throw new Error(data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞');
        }
        
        const summary = data.summary;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —É—Ä–æ–≤–µ–Ω—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        const level = summary.user_level;
        document.getElementById('widget-level').textContent = level.current_level;
        document.getElementById('widget-points').textContent = level.total_points;
        
        const progressFill = document.getElementById('widget-level-progress');
        progressFill.style.width = level.progress_to_next_level + '%';
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –±—ã—Å—Ç—Ä—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        document.getElementById('widget-streak').textContent = summary.active_streak;
        document.getElementById('widget-consistency').textContent = Math.round(summary.consistency_score) + '%';
        document.getElementById('widget-achievements').textContent = summary.total_points; // –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ—á–∫–∏ –∫–∞–∫ –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –±–ª–∏–∂–∞–π—à–∏–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è
        updateNextAchievements(summary.next_achievements);
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç
        content.style.display = 'block';
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –≤–∏–¥–∂–µ—Ç–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞:', error);
        document.getElementById('widget-error').style.display = 'flex';
    } finally {
        loading.style.display = 'none';
    }
}

function updateNextAchievements(achievements) {
    const container = document.getElementById('widget-next-achievements');
    const noAchievements = document.getElementById('widget-no-achievements');
    
    if (!achievements || achievements.length === 0) {
        container.style.display = 'none';
        noAchievements.style.display = 'block';
        return;
    }
    
    container.style.display = 'block';
    noAchievements.style.display = 'none';
    container.innerHTML = '';
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–∞–∫—Å–∏–º—É–º 3 –±–ª–∏–∂–∞–π—à–∏—Ö –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è
    const achievementsToShow = achievements.slice(0, 3);
    
    achievementsToShow.forEach(achievement => {
        const achievementEl = document.createElement('div');
        achievementEl.className = 'achievement-item';
        achievementEl.innerHTML = `
            <div class="achievement-icon">${achievement.icon}</div>
            <div class="achievement-info">
                <div class="achievement-title">${achievement.title}</div>
                <div class="achievement-progress">${achievement.current_progress} / ${achievement.target_value}</div>
                <div class="achievement-progress-bar">
                    <div class="achievement-progress-fill" style="width: ${achievement.progress_percentage}%"></div>
                </div>
            </div>
        `;
        container.appendChild(achievementEl);
    });
}

// –ó–∞–≥—Ä—É–∂–∞–µ–º –≤–∏–¥–∂–µ—Ç –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', () => {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
    if (document.querySelector('.progress-widget')) {
        loadProgressWidget();
    }
});
</script>