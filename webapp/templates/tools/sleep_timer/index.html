{% extends 'base.html' %}

{% block title %}Mom&BabyBot - Таймер сна{% endblock %}

{% block content %}
<div class="glass-container mb-6">
    <h1 class="text-2xl font-bold mb-4">Таймер сна</h1>
    <p class="text-dark-gray mb-4">Отслеживайте режим сна вашего ребенка для установления здоровых привычек.</p>
</div>

<div class="neo-container mb-6">
    <div class="flex flex-col items-center justify-center py-6">
        <div id="timer" class="text-4xl font-bold mb-6">00:00:00</div>
        
        <div class="mb-6">
            <div class="flex items-center justify-center space-x-4 mb-4">
                <span>Тип сна:</span>
                <div class="neo-tabs" data-tab-group="sleep-type">
                    <div class="neo-tab active" data-tab-target="day-sleep">Дневной</div>
                    <div class="neo-tab" data-tab-target="night-sleep">Ночной</div>
                </div>
            </div>
        </div>
        
        <div class="flex space-x-4 mb-6">
            <button id="startButton" class="neo-button bg-accent-secondary px-8 py-3">Начать</button>
            <button id="stopButton" class="neo-button bg-accent px-8 py-3" disabled>Завершить</button>
        </div>
        
        <div id="stats" class="w-full max-w-md">
            <div class="flex justify-between mb-2">
                <span>Текущий сон:</span>
                <span id="currentSleepType">Дневной</span>
            </div>
            <div class="flex justify-between mb-2">
                <span>Начало:</span>
                <span id="startTime">-</span>
            </div>
        </div>
        
        <div id="sleepQualityContainer" class="w-full max-w-md mt-4 hidden">
            <div class="mb-2">
                <span>Качество сна:</span>
            </div>
            <div class="flex justify-center space-x-2">
                <button class="quality-btn neo-button" data-quality="1">1</button>
                <button class="quality-btn neo-button" data-quality="2">2</button>
                <button class="quality-btn neo-button" data-quality="3">3</button>
                <button class="quality-btn neo-button" data-quality="4">4</button>
                <button class="quality-btn neo-button" data-quality="5">5</button>
            </div>
            <div class="text-center mt-2 text-sm text-dark-gray">
                <span>1 - Плохо, 5 - Отлично</span>
            </div>
        </div>
    </div>
</div>

<div class="glass-container mb-6">
    <h2 class="text-xl font-bold mb-4">История сна</h2>
    <div id="sleepHistory" class="space-y-4">
        <p id="noHistoryMessage" class="text-center text-dark-gray">История сна будет отображаться здесь</p>
    </div>
</div>

<div class="neo-container">
    <h2 class="text-xl font-bold mb-4">Визуализация режима сна</h2>
    <div id="sleepChart" class="h-64 bg-white rounded-lg p-4">
        <canvas id="sleepChartCanvas"></canvas>
    </div>
</div>

<!-- Скрытые поля для хранения ID пользователя и ребенка -->
<input type="hidden" id="userId" value="{{ user_id }}">
<input type="hidden" id="childId" value="{{ child_id }}">
{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block extra_js %}
// Глобальные переменные
const userId = document.getElementById('userId').value;
const childId = document.getElementById('childId').value;
let currentSessionId = null;
let timerInterval = null;
let startTime = null;
let sleepType = 'day';
let sleepQuality = 3;
let chart = null;

// DOM элементы
const timerElement = document.getElementById('timer');
const startButton = document.getElementById('startButton');
const stopButton = document.getElementById('stopButton');
const currentSleepTypeElement = document.getElementById('currentSleepType');
const startTimeElement = document.getElementById('startTime');
const sleepHistoryElement = document.getElementById('sleepHistory');
const noHistoryMessage = document.getElementById('noHistoryMessage');
const sleepQualityContainer = document.getElementById('sleepQualityContainer');
const qualityButtons = document.querySelectorAll('.quality-btn');

// Инициализация
document.addEventListener('DOMContentLoaded', () => {
    // Загрузка истории сна
    loadSleepHistory();
    
    // Загрузка статистики для графика
    loadSleepStatistics();
    
    // Обработчики событий для вкладок типа сна
    document.querySelectorAll('.neo-tab').forEach(tab => {
        tab.addEventListener('click', () => {
            document.querySelectorAll('.neo-tab').forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            
            if (tab.dataset.tabTarget === 'day-sleep') {
                sleepType = 'day';
                currentSleepTypeElement.textContent = 'Дневной';
            } else {
                sleepType = 'night';
                currentSleepTypeElement.textContent = 'Ночной';
            }
        });
    });
    
    // Обработчик для кнопки "Начать"
    startButton.addEventListener('click', startSleepTimer);
    
    // Обработчик для кнопки "Завершить"
    stopButton.addEventListener('click', stopSleepTimer);
    
    // Обработчики для кнопок качества сна
    qualityButtons.forEach(button => {
        button.addEventListener('click', () => {
            qualityButtons.forEach(btn => btn.classList.remove('bg-primary'));
            button.classList.add('bg-primary');
            sleepQuality = parseInt(button.dataset.quality);
        });
    });
    
    // Проверка наличия активной сессии в localStorage
    checkForActiveSleepSession();
});

// Функция для форматирования времени
function formatTime(seconds) {
    const hours = Math.floor(seconds / 3600);
    const minutes = Math.floor((seconds % 3600) / 60);
    const secs = seconds % 60;
    
    return [
        hours.toString().padStart(2, '0'),
        minutes.toString().padStart(2, '0'),
        secs.toString().padStart(2, '0')
    ].join(':');
}

// Функция для форматирования даты и времени
function formatDateTime(dateString) {
    const date = new Date(dateString);
    return date.toLocaleString('ru-RU', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
}

// Функция для расчета продолжительности в минутах
function calculateDuration(startTime, endTime) {
    const start = new Date(startTime);
    const end = endTime ? new Date(endTime) : new Date();
    return Math.round((end - start) / (1000 * 60));
}

// Функция для форматирования продолжительности
function formatDuration(minutes) {
    const hours = Math.floor(minutes / 60);
    const mins = minutes % 60;
    
    if (hours > 0) {
        return `${hours} ч ${mins} мин`;
    } else {
        return `${mins} мин`;
    }
}

// Функция для запуска таймера сна
async function startSleepTimer() {
    try {
        // Создаем новую сессию сна через API
        const response = await fetch(`/api/users/${userId}/children/${childId}/sleep/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                type: sleepType
            })
        });
        
        if (!response.ok) {
            throw new Error('Не удалось создать сессию сна');
        }
        
        const data = await response.json();
        currentSessionId = data.id;
        startTime = new Date(data.start_time);
        
        // Сохраняем информацию о текущей сессии в localStorage
        localStorage.setItem('activeSleepSession', JSON.stringify({
            sessionId: currentSessionId,
            startTime: startTime,
            type: sleepType,
            userId: userId,
            childId: childId
        }));
        
        // Обновляем UI
        startButton.disabled = true;
        stopButton.disabled = false;
        startTimeElement.textContent = formatDateTime(startTime);
        
        // Запускаем таймер
        let seconds = 0;
        timerInterval = setInterval(() => {
            seconds++;
            timerElement.textContent = formatTime(seconds);
        }, 1000);
        
    } catch (error) {
        console.error('Ошибка при запуске таймера:', error);
        alert('Произошла ошибка при запуске таймера сна');
    }
}

// Функция для остановки таймера сна
async function stopSleepTimer() {
    try {
        // Показываем контейнер для выбора качества сна
        sleepQualityContainer.classList.remove('hidden');
        
        // Останавливаем таймер
        clearInterval(timerInterval);
        
        // Завершаем сессию сна через API
        const response = await fetch(`/api/users/${userId}/children/${childId}/sleep/${currentSessionId}/`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                end_session: true,
                quality: sleepQuality
            })
        });
        
        if (!response.ok) {
            throw new Error('Не удалось завершить сессию сна');
        }
        
        // Удаляем информацию о текущей сессии из localStorage
        localStorage.removeItem('activeSleepSession');
        
        // Обновляем UI
        startButton.disabled = false;
        stopButton.disabled = true;
        
        // Перезагружаем историю сна и статистику
        loadSleepHistory();
        loadSleepStatistics();
        
        // Сбрасываем таймер
        timerElement.textContent = '00:00:00';
        startTimeElement.textContent = '-';
        currentSessionId = null;
        startTime = null;
        
        // Скрываем контейнер для выбора качества сна через 3 секунды
        setTimeout(() => {
            sleepQualityContainer.classList.add('hidden');
        }, 3000);
        
    } catch (error) {
        console.error('Ошибка при остановке таймера:', error);
        alert('Произошла ошибка при завершении таймера сна');
    }
}

// Функция для загрузки истории сна
async function loadSleepHistory() {
    try {
        const response = await fetch(`/api/users/${userId}/children/${childId}/sleep/`);
        
        if (!response.ok) {
            throw new Error('Не удалось загрузить историю сна');
        }
        
        const data = await response.json();
        const sleepSessions = data.sleep_sessions;
        
        // Очищаем историю
        sleepHistoryElement.innerHTML = '';
        
        if (sleepSessions.length === 0) {
            sleepHistoryElement.innerHTML = '<p class="text-center text-dark-gray">История сна пуста</p>';
            return;
        }
        
        // Сортируем сессии по дате (новые сверху)
        sleepSessions.sort((a, b) => new Date(b.start_time) - new Date(a.start_time));
        
        // Отображаем последние 10 сессий
        const recentSessions = sleepSessions.slice(0, 10);
        
        recentSessions.forEach(session => {
            const sessionElement = document.createElement('div');
            sessionElement.className = 'glass-card p-4';
            
            const typeLabel = session.type === 'day' ? 'Дневной сон' : 'Ночной сон';
            const startTime = formatDateTime(session.start_time);
            const endTime = session.end_time ? formatDateTime(session.end_time) : 'В процессе';
            const duration = session.end_time ? formatDuration(calculateDuration(session.start_time, session.end_time)) : 'В процессе';
            
            let qualityStars = '';
            if (session.quality) {
                for (let i = 1; i <= 5; i++) {
                    if (i <= session.quality) {
                        qualityStars += '★';
                    } else {
                        qualityStars += '☆';
                    }
                }
            }
            
            sessionElement.innerHTML = `
                <div class="flex justify-between items-center mb-2">
                    <span class="font-semibold">${typeLabel}</span>
                    <span class="text-sm text-dark-gray">${startTime}</span>
                </div>
                <div class="grid grid-cols-2 gap-2 text-sm">
                    <div>
                        <span class="text-dark-gray">Окончание:</span>
                        <span>${endTime}</span>
                    </div>
                    <div>
                        <span class="text-dark-gray">Продолжительность:</span>
                        <span>${duration}</span>
                    </div>
                    ${session.quality ? `
                    <div>
                        <span class="text-dark-gray">Качество:</span>
                        <span class="text-yellow-500">${qualityStars}</span>
                    </div>
                    ` : ''}
                </div>
            `;
            
            sleepHistoryElement.appendChild(sessionElement);
        });
        
    } catch (error) {
        console.error('Ошибка при загрузке истории сна:', error);
        sleepHistoryElement.innerHTML = '<p class="text-center text-dark-gray">Не удалось загрузить историю сна</p>';
    }
}

// Функция для загрузки статистики сна
async function loadSleepStatistics() {
    try {
        const response = await fetch(`/api/users/${userId}/children/${childId}/sleep/statistics/`);
        
        if (!response.ok) {
            throw new Error('Не удалось загрузить статистику сна');
        }
        
        const data = await response.json();
        
        // Создаем график
        createSleepChart(data);
        
    } catch (error) {
        console.error('Ошибка при загрузке статистики сна:', error);
        document.getElementById('sleepChart').innerHTML = '<p class="text-center text-dark-gray">Не удалось загрузить статистику сна</p>';
    }
}

// Функция для создания графика сна
function createSleepChart(data) {
    const ctx = document.getElementById('sleepChartCanvas').getContext('2d');
    
    // Если график уже существует, уничтожаем его
    if (chart) {
        chart.destroy();
    }
    
    // Создаем новый график
    chart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['Дневной сон', 'Ночной сон'],
            datasets: [{
                label: 'Среднее время сна (мин)',
                data: [data.avg_day_sleep, data.avg_night_sleep],
                backgroundColor: [
                    'rgba(255, 214, 224, 0.7)',
                    'rgba(226, 214, 255, 0.7)'
                ],
                borderColor: [
                    'rgba(255, 214, 224, 1)',
                    'rgba(226, 214, 255, 1)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Минуты'
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const value = context.raw;
                            return formatDuration(value);
                        }
                    }
                }
            }
        }
    });
}

// Функция для проверки наличия активной сессии в localStorage
function checkForActiveSleepSession() {
    const savedSession = localStorage.getItem('activeSleepSession');
    
    if (savedSession) {
        const session = JSON.parse(savedSession);
        
        // Проверяем, что сессия принадлежит текущему пользователю и ребенку
        if (session.userId == userId && session.childId == childId) {
            currentSessionId = session.sessionId;
            startTime = new Date(session.startTime);
            sleepType = session.type;
            
            // Обновляем UI
            startButton.disabled = true;
            stopButton.disabled = false;
            startTimeElement.textContent = formatDateTime(startTime);
            
            // Устанавливаем правильный тип сна
            document.querySelectorAll('.neo-tab').forEach(tab => {
                tab.classList.remove('active');
                if ((tab.dataset.tabTarget === 'day-sleep' && sleepType === 'day') || 
                    (tab.dataset.tabTarget === 'night-sleep' && sleepType === 'night')) {
                    tab.classList.add('active');
                }
            });
            
            currentSleepTypeElement.textContent = sleepType === 'day' ? 'Дневной' : 'Ночной';
            
            // Запускаем таймер
            const elapsedSeconds = Math.floor((new Date() - startTime) / 1000);
            timerElement.textContent = formatTime(elapsedSeconds);
            
            let seconds = elapsedSeconds;
            timerInterval = setInterval(() => {
                seconds++;
                timerElement.textContent = formatTime(seconds);
            }, 1000);
        }
    }
}
{% endblock %}